buildscript{
  project.ext.outputDir = "build/output"
}

task buildOutputDir{
  doLast{
    def file = project.file(project.outputDir)
    if(!file.exists()){
      file.mkdirs()
    }
  }
}

task preample(type:Exec, dependsOn: ":buildOutputDir"){
  workingDir '.'

  commandLine "lualatex", "-synctex=1", "-interaction=nonstopmode", "-output-directory=${properties.ouputDir}", "\"Preamble\".tex"
}

task build(type:Exec, dependsOn: ":buildOutputDir"){
  workingDir '.'
  commandLine "lualatex", "-synctex=1", "-interaction=nonstopmode", "-output-directory=${properties.ouputDir}", "\"Labnik-III\".tex"
}

def buildFragment(String outputDir, Map parameters){
  def template = file("Template.tex").text.replace("\\","\\\\")
  def input = new groovy.text.SimpleTemplateEngine().createTemplate(template).make(parameters).toString()
  def tempFile = new File(project.buildDir,"frag_${parameters.fragment}.tex")

  tempFile.text = input
  exec{
    workingDir '.'
    commandLine "lualatex", "-synctex=1", "-interaction=nonstopmode", "-output-directory=${parameters.outputDir}", "-job-name=\"${parameters.fragment}\"", "${tempFile.absolutePath}"
    //standardInput = new ByteArrayInputStream(input.getBytes("UTF-8"))
  }
  exec{
    workingDir '.'
    commandLine "lualatex", "-synctex=1", "-interaction=nonstopmode", "-output-directory=${parameters.outputDir}", "-job-name=\"${parameters.fragment}\"", "${tempFile.absolutePath}"
    //standardInput = new ByteArrayInputStream(input.getBytes("UTF-8"))
  }
}

task fragment(dependsOn: ":buildOutputDir"){
  doLast{
    buildFragment(outputDir, project.properties)
  }
}

task chapters(){
  doLast{
    def threads = (1..6).collect{
      def parameters = new HashMap(project.properties)
      parameters.title = "Chapter $it"
      parameters.fragment = "Chapter_$it"
      parameters.chapter = it
      Thread.start{
          buildFragment(outputDir, parameters)
      }
    }

    threads.each{it.join()}
  }
}
