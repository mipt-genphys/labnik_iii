\RequirePackage{ifpdf, ifluatex}

% ams - загружаем первыми
\RequirePackage{amsmath}  % дополнительные возможности математики AMS
\RequirePackage{amssymb}  % дополнительные символы AMS

%%% rules for differen toolsets

\ifpdf
\ifluatex
	%%% Language setting for (xe|lua)latex %%%
	\usepackage{fontspec}
	\RequirePackage[math-style=TeX]{unicode-math}
	\setmainfont{CMU Serif}
	\setsansfont{CMU Sans Serif}
	\setmonofont{CMU Typewriter Text}
	\newfontfamily{\cyrillicfonttt}{CMU Serif}
	\setmathfont{XITS Math}[math-style=TeX]

	\RequirePackage{polyglossia}
	\setdefaultlanguage[spelling=modern]{russian}

	% Фикс для русских букв в формулах
	\DeclareSymbolFont{cyrletters}{\encodingdefault}{\familydefault}{m}{it}
	\newcommand{\makecyrmathletter}[1]{%
	  \begingroup\lccode`a=#1\lowercase{\endgroup
	  \Umathcode`a}="0 \csname symcyrletters\endcsname\space #1
	}
	\count255="409
	\loop\ifnum\count255<"44F
	  \advance\count255 by 1
	  \makecyrmathletter{\count255}
	\repeat

	\RequirePackage{hyperref}
	\hypersetup{%
		pdfencoding=auto
	}
\else
	%	\RequirePDFTeX % Tests for PDFTEX use and throws an error if a different engine is being used.

	%%% For proper copypasting of text from pdf %%%
	\RequirePackage{cmap} % Better search and copypasting of cyrillic text from pdf-file. Can cause errors if used together with pdfx package.
	\defaulthyphenchar=127 % Better hyphenation for copypasting. Must be set just before fontenc.

	%%% Language setting for pdflatex %%%
    \RequirePackage[unicode]{hyperref}
    \RequirePackage{mathtext}
	\RequirePackage[T2A]{fontenc}
	\RequirePackage[utf8]{inputenc}
	\RequirePackage[russian]{babel}

    % косые интегралы ранят мои патриотические чувства
    \DeclareSymbolFont{lsymb}{U}{euex}{m}{n}
    \DeclareMathSymbol{\intop}{\mathop}{lsymb}{"52}
    \DeclareMathSymbol{\ointop}{\mathop}{lsymb}{"48}
    \DeclareMathSymbol{\smallint}{\mathop}{lsymb}{"52}
\fi
\fi

\RequirePackage{soulutf8}

%%% Пакеты
\RequirePackage{icomma}     % десятичная запятая без пробела
\RequirePackage[font=small, labelsep=period]{caption} % подписи к рисункам

\RequirePackage{graphicx}   % вставка графики
%\RequirePackage{grffile}    % Проблемы с именами картинок
\RequirePackage{wrapfig}    % обтекание объектов
\RequirePackage{subcaption} % подкартинки
\RequirePackage{color}      % цветной текст
\RequirePackage{import}     % импорт рисунков для pdf+tex
\RequirePackage{chngcntr}   % продвинутые счетчики

\RequirePackage{array}      % дополнительные стили для таблиц
\RequirePackage{booktabs}
\RequirePackage{longtable}  % таблицы на несколько страниц
\RequirePackage{enumitem}   % расширенные свойства списков

\RequirePackage{csquotes}   % кавычки

\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

\RequirePackage{epstopdf}
\RequirePackage{todonotes}  % for revision

% cноски в виде звездочек
\RequirePackage[perpage,symbol*]{footmisc}

% рамки для замечаний
\RequirePackage[%
        leftmargin=2pt,%
        topline=false,%
        bottomline=false,%
        skipabove=\medskipamount,%
        skipbelow=\medskipamount%
    ]{mdframed}


%%% Общие настройки

% FIXME: конфликты имен между разными папками!
\graphicspath{{Images/}{Images/Chapter_1/}{Images/Chapter_2/}{Images/Chapter_3/}{Images/Chapter_4/}{Images/Chapter_5/}{Images/Chapter_6/}}

\newcounter{semester}
\setcounter{semester}{3}

\setcounter{secnumdepth}{3} % FIXME: почему 4?


%%% Команды оформления лаб

\newenvironment{lab:aim}{%
    \hangindent=\parindent
	\small\textbf{Цель работы:~}%
}{\par\medskip}

% короткая запись для окружения lab:aim
\newcommand{\aim}[1]{\begin{lab:aim}#1\end{lab:aim}}

\newenvironment{lab:equipment}{%
    \hangindent=\parindent
	\small\textbf{В работе используются:}
}{%
	\par\bigskip%
}

% короткая запись для окружения lab:equipment
\newcommand{\equip}[1]{%
	\begin{lab:equipment}%
	#1\par%
	\end{lab:equipment}%
}

% Ссылка на теоретическую часть
\newenvironment{lab:theory}{%
	\noindent\textbf{Теоретическая часть:~}%
	\begin{small}%
	}{%
	\end{small}\par%
	\medskip%
}

% короткая запись для окружения lab:theory
\newcommand{\theory}[1]{%
	\begin{lab:theory}%
	#1\par%
	\end{lab:theory}%
}

% Секции в описании работы без нумерации
\newcommand{\labsection}[1]{\subsection*{#1}}
\newcommand{\labsubsection}[1]{\paragraph{#1}}

% Секции в теорвведениях
\newcommand{\introsection}[2][]{%
    \ifblank{#1}{\section{#2}}{\section[#1]{#2}}}
\newcommand{\introsubsection}[2][]{%
    \ifblank{#1}{\subsection{#2}}{\subsection[#1]{#2}}}

% ЗАДАНИЕ
\newcommand{\labtask}{\taskblock*{\large ЗАДАНИЕ}}



% формат нумерованного списка для задания к работе
\newlist{tasklist}{enumerate}{2}
\setlist[tasklist]{
    leftmargin=\parindent,
    itemsep=0pt,
    topsep=0pt,
    label=\arabic*.,
    ref=\arabic*}

% Задание
\newenvironment{lab:task}{%
    \labtask
    \begin{tasklist}%
}{%
    \end{tasklist}%
}

% workaround for enumitem changin parindent
\newlength{\globalparindent}
\setlength{\globalparindent}{\parindent}

% Аннотация к заданию после слова ЗАДАНИЕ
\newcommand{\taskpreamble}[1]{%
\item[] \hspace*{-\globalparindent}\parbox{\textwidth}{#1}%
}

% секция задания
\newcommand{\tasksection}[1]{%
    \end{tasklist}%
    \tasksubsection*{#1}%
    \begin{tasklist}[resume]%
}


% Контрольные вопросы
\newenvironment{lab:questions}{%
	\taskblock*{Контрольные вопросы}
	\begin{enumerate}[leftmargin=\parindent]\small%
	}{
	\end{enumerate}%
}

% Литература
\newenvironment{lab:literature}{%
    \taskblock*{Литература}
	\begin{enumerate}[leftmargin=\parindent]\small
	}{
	\end{enumerate}%
}

% Experiment setup block
\newcommand{\experiment}{\labsection{Экспериментальная установка}}

% Warning block environment
\newenvironment{lab:warning}{%
    \begin{mdframed}[topline=true,bottomline=true]
        \centering
	\textbf{Внимание!}\par
}{%
	\par
    \end{mdframed}%
}

% Warning block
\newcommand{\warning}[1]{%
	\begin{lab:warning}
	#1
	\end{lab:warning}%
}

% Термин
%\newcommand{\term}[1]{\textbf{\textit{#1}}}
\sodef\textso{}{0.175em}{0.65em plus 0.08em minus 0.06em}{0.55em plus 0.275em minus 0.183em}
\newcommand{\term}[1]{\textso{\sffamily #1}}

% Important text
\newcommand{\important}[1]{\emph{#1}}


% Команда для замечаний
\newenvironment{lab:note}{%
    \par\begin{mdframed}\small\textbf{Замечание.~}%
}{%
\par\end{mdframed}%
}

% Команда для нумерованых примеров

\newcounter{example}[chapter]
\renewcommand{\theexample}{\arabic{example}}

\newenvironment{lab:example}{%
	\refstepcounter{example}%
	\par\medskip\noindent\footnotesize%
	\textbf{Пример \theexample.~}%
}{%
    \par\medskip%
}


\newcounter{exercise}[chapter]
\renewcommand{\theexercise}{\arabic{exercise}}

\newenvironment{lab:exercise}{%
    \refstepcounter{exercise}%
    \par\medskip\noindent\footnotesize%
    \textbf{Упражнение \theexercise.~}%
}{%
\par\medskip%
}

%%% Нумерация
% Вставить номер уравнения внутри главы или работы
\newcommand{\eqmark}[1]{\label{eq:\arabic{chapter}.\arabic{lab}.#1}}
% Ссылка на уравнение
\renewcommand{\eqref}[1]{(\ref{eq:\arabic{chapter}.\arabic{lab}.#1})}

% Ссылка на уравнение в преамбуле главы.
% По-умолчанию используется текущая глава, но можно задать вручную
\newcommand{\chaptereqref}[2][\arabic{chapter}]{(\ref{eq:#1.0.#2})}

% Вставить номер рисунка внутри главы или работы
\newcommand{\figmark}[1]{\label{fig:\arabic{chapter}.\arabic{lab}.#1}}
% Ссылка на рисунок
\newcommand{\figref}[1]{\ref{fig:\arabic{chapter}.\arabic{lab}.#1}}

% Ссылка на рисунок в преамбуле главы. По умолчанию используется текущая глава, но можно задать вручную
\newcommand{\chapterfigref}[2][\arabic{chapter}]{\ref{fig:#1.0.#2}}

% Вставить номер рисунка внутри главы или работы
\newcommand{\tabmark}[1]{\label{tab:\arabic{chapter}.\arabic{lab}.#1}}
% Ссылка на рисунок
\newcommand{\tabref}[1]{\ref{tab:\arabic{chapter}.\arabic{lab}.#1}}

%%% Форматирование

\frenchspacing
\righthyphenmin=2
\sloppy
\raggedbottom

% косые больше/меньше
\renewcommand*{\le}{\leqslant}
\renewcommand*{\ge}{\geqslant}

% latex не умеет по-русски переносить равенства и неравенства
\binoppenalty=10000
\relpenalty=10000

% перенос вручную
\newcommand*{\hm}[1]{#1\nobreak\discretionary{}{\hbox{$\mathsurround=0pt #1$}}{}}

% нумерация внутри уравнений русскими буквами
%\newcommand*{\thesubequation}{\theparentequation \asbuk{equation}}

\newcommand{\pic}[2]{%
  \ifblank{#1}% then
      {}% else
      {\def\svgwidth{#1}}
  \input{\detokenize{Images/#2.pdf_tex}}%
}


\newcounter{lab}[chapter]
%\numberwithin{lab}{chapter}



% форматироание секций
\RequirePackage[explicit, pagestyles]{titlesec}
\RequirePackage[dotinlabels]{titletoc}


\titleclass{\chapter}{top}
\renewcommand{\thechapter}{\Roman{chapter}}
\titlespacing{\chapter}{0pt}{2pc}{1pc}
\titleformat{\chapter}[display]{\vspace*{-50pt}\thispagestyle{empty}}%
    {\sffamily\Large Раздел \Roman{chapter}\strut}{1pc}%
    {\Large\bfseries\raggedright\MakeUppercase{#1}}%
    [\vspace{3pc}]


\titleclass{\lab}{straight}[\chapter]
\renewcommand{\thelab}{\arabic{semester}.\arabic{chapter}.\arabic{lab}}
\titlespacing{\lab}{\parindent}{*2}{*1}
\titleformat{\lab}[display]%
    {%
%        \renewcommand{\theequation}{\arabic{equation}}%
        \clearpage\bfseries%
    }%
    {Работа~\thelab}{1ex}%
    {\large\raggedright #1}%
    [\vspace*{2ex}]


\renewcommand{\thesection}{\arabic{section}}
\titlespacing{\section}{0pt}{*2}{*1}
\titleformat{\section}[hang]%
    {\normalsize\bfseries\raggedright}{\thesection.}{1ex}{#1}


\titlespacing{\subsection}{0pt}{*2}{*0.5}
\titleformat{\subsection}[hang]%
    {\small\bfseries\raggedright}{\thesubsection.}{1ex}{#1}


%\titleclass{\paragraph}{straight}
\titlespacing{\paragraph}{\parindent}{0pt}{1ex}
\titleformat{\paragraph}[runin]{\bfseries\sffamily}{}{}{#1.}



\titlecontents{chapter}[0pt]{\addvspace{2pc}}%
    {{\sffamily Р а з д е л~~\thecontentslabel.}~~\bfseries}%
    {\bfseries}%
    {\hfill\textbf{\contentspage}}%
    [\addvspace{1pc}]


\titlecontents{lab}[7em]{}%
    {\contentslabel[\sffamily Работа~\thecontentslabel.]{7em}}%
    {}%
    {\titlerule*[0.5pc]{.}\contentspage}

\titlecontents{section}[1.5em]{}%
    {\contentslabel[\thecontentslabel.]{1.5em}}%
    {\hspace*{-1.5em}}%
    {\titlerule*[0.5pc]{.}\contentspage}


% FIXME: subsection format not working! Bug in titlesec?
%\titlecontents{subsection}[4.5em]{}%
%    {\footnotesize\contentslabel[\thecontentslabel.]{1.5em}}%
%    {\hspace*{-1.5em}}%
%    {\titlerule*[0.5pc]{.}\contentspage}


\titleclass{\taskblock}{straight}[\subsection]
\titlespacing{\taskblock}{0pt}{*2}{*1}
\titleformat{\taskblock}[hang]%
    {\sffamily\bfseries\centering}{}{1ex}{#1}


\titleclass{\tasksubsection}{straight}[\taskblock]
\titlespacing{\tasksubsection}{0pt}{*2}{*1}
\titleformat{\tasksubsection}[hang]%
    {\sffamily\centering}{}{1ex}{#1}


% ПРИЛОЖЕНИЕ к работе
\newcounter{supplement}[lab]
\renewcommand{\thesupplement}{\arabic{supplement}}
%\newcounter{labsave}
\newenvironment{labsupplement}[1][]{%
    \refstepcounter{supplement}%
    %    \setcounter{labsave}{\value{lab}}% save lab number
    %    \setcounter{lab}{0}%
    %    \vspace{\medskipamount}%
    \clearpage
    \ifblank{#1}{%
        \taskblock*{ПРИЛОЖЕНИЕ}%
    }{%
    \taskblock*{ПРИЛОЖЕНИЕ\\[1ex] \normalsize #1}%
    \addcontentsline{toc}{section}{\small\textsf{Приложение.} #1}%
}
\begingroup%
\small%
}{%
%    \setcounter{lab}{\value{labsave}} % restore lab number
\endgroup%
}


\counterwithin{equation}{supplement}
\counterwithin{equation}{lab}
\counterwithin{equation}{chapter}
\counterwithin{figure}{supplement}
\counterwithin{figure}{lab}
\counterwithin{figure}{chapter}
\counterwithin{table}{lab}

% Отличная нумерация внутри введения
\RequirePackage{etoolbox}


\renewcommand{\theequation}{%
    \ifnumequal{\value{lab}}{0}%
    {\arabic{chapter}.\arabic{equation}}%
    {\arabic{equation}}%
}


\renewcommand{\thefigure}{%
    \ifnumequal{\value{lab}}{0}%
    {\arabic{chapter}.\arabic{figure}}%
    {\arabic{figure}}%
}

\renewcommand{\thetable}{%
    \ifnumequal{\value{lab}}{0}%
    {\arabic{chapter}.\arabic{table}}%
    {\arabic{table}}%
}


% Красивые и умные колонтитулы

\newpagestyle{main}{%
    \headrule
    \sethead[\thepage][][\sffamily\chaptertitle]% even
    {\ifnumequal{\value{lab}}{0}{\normalsize\sffamily Раздел \Roman{chapter}}{\sffamily Работа~\thelab}}{}{\thepage} % odd
}

\pagestyle{main}

% стиль векторов(?)
\let\ovec\vec
\renewcommand*{\vec}[1]{{\boldsymbol{#1}}}