%%% rules for differen toolsets

\RequirePackage{ifpdf,ifxetex,ifluatex}

%%% Заготовка для портирования в html
% \RequirePackage[
% 	% HomeHTMLFilename=index, % Filename of the homepage.
% 	% HTMLFilename={node-}, % Filename prefix of other pages.
% 	% IndexLanguage=russian, % Language for xindy index, glossary.
% 	% latexmk, % Use latexmk to compile.
% 	% OSWindows, % Force Windows. (Usually automatic.)
% 	mathjax, % Use MathJax to display math.
% ]{lwarp}


\RequirePackage{amsmath}  % дополнительные возможности математики AMS
\RequirePackage{amssymb}  % дополнительные символы AMS
\ifluatex

	%%% Language setting for (xe|lua)latex %%%
	\usepackage{fontspec}
	\RequirePackage[math-style=TeX]{unicode-math}
	\setmainfont{CMU Serif}
	\setsansfont{CMU Sans Serif}
	\setmonofont{CMU Typewriter Text}
	\newfontfamily{\cyrillicfonttt}{CMU Serif}
	\setmathfont{XITS Math}[math-style=TeX]

	\RequirePackage{polyglossia}
	\setdefaultlanguage[spelling=modern]{russian}

	% Фикс для русских букв в формулах
	\DeclareSymbolFont{cyrletters}{\encodingdefault}{\familydefault}{m}{it}
	\newcommand{\makecyrmathletter}[1]{%
	  \begingroup\lccode`a=#1\lowercase{\endgroup
	  \Umathcode`a}="0 \csname symcyrletters\endcsname\space #1
	}
	\count255="409
	\loop\ifnum\count255<"44F
	  \advance\count255 by 1
	  \makecyrmathletter{\count255}
	\repeat

%	\RequirePackage{minted}

	%\setmathfont{Latin Modern Math}

\else
	%	\RequirePDFTeX % Tests for PDFTEX use and throws an error if a different engine is being used.

	%%% For proper copypasting of text from pdf %%%
	\RequirePackage{cmap} % Better search and copypasting of cyrillic text from pdf-file. Can cause errors if used together with pdfx package.
	\defaulthyphenchar=127 % Better hyphenation for copypasting. Must be set just before fontenc.

	%%% Language setting for pdflatex %%%
    \RequirePackage[unicode]{hyperref}
    \RequirePackage{mathtext}
	\RequirePackage[T2A]{fontenc}
	\RequirePackage[utf8]{inputenc}
	\RequirePackage[russian]{babel}
	\RequirePackage{soulutf8}

    % косые интегралы ранят мои патриотические чувства
    \DeclareSymbolFont{lsymb}{U}{euex}{m}{n}
    \DeclareMathSymbol{\intop}{\mathop}{lsymb}{"52}
    \DeclareMathSymbol{\ointop}{\mathop}{lsymb}{"48}
    \DeclareMathSymbol{\smallint}{\mathop}{lsymb}{"52}
\fi


%%% Пакеты
\RequirePackage{icomma} % десятичная запятая без пробела
\RequirePackage[font=small, labelsep=period]{caption} % подписи к рисункам

\RequirePackage{graphicx} % вставка графики
\RequirePackage{wrapfig}  % обтекание объектов
\RequirePackage{subcaption} % подкартинки
%\RequirePackage{psfrag}   % вставка надписей
\RequirePackage{color}    % цветной текст
\RequirePackage{import}   % импорт рисунков для pdf+tex
%\RequirePackage{hyperref}
%\hypersetup{pdfencoding=auto}

\RequirePackage{array}     % дополнительные стили для таблиц
\RequirePackage{booktabs}
\RequirePackage{longtable} % таблицы на несколько страниц
%\RequirePackage{xifthen}
%\RequirePackage{calc}      % вычисления

\RequirePackage{epstopdf}

\RequirePackage{todonotes} % for revision

\ifluatex
\RequirePackage{hyperref}
\hypersetup{%
	pdfencoding=auto
}
\fi

%%% Общие настройки

\graphicspath{{./Images/}}

\def\semester{3}

\newcounter{lab}[chapter]

\numberwithin{lab}{chapter}
\numberwithin{equation}{lab}
\numberwithin{figure}{lab}
\numberwithin{table}{lab}


%%% Команды оформления лаб

\newcommand{\lab}[2][\arabic{chapter}.\arabic{lab}]{ % Страшный крокодил нужен что бы номер лабы вычислялся правильно при создании заголовка.
	\refstepcounter{lab}
	\section*{Работа #1. #2}
	\addcontentsline{toc}{section}{Работа #1. #2}%
}

\newenvironment{lab:aim}{%
	\noindent\textbf{Цель работы:~}\begin{small}%
	}{%
	\end{small}\par
	\medskip%
}

% короткая запись для окружения lab:aim
\newcommand{\aim}[1]{\begin{lab:aim}#1\end{lab:aim}}

\newenvironment{lab:equipment}{%
	\noindent\textbf{В работе используются:~}
	\begin{small}%
	}{
	\end{small}\par
	\medskip%
}

% короткая запись для окружения lab:equipment
\newcommand{\equip}[1]{%
	\begin{lab:equipment}
	#1\par
	\end{lab:equipment}%
}

% Ссылка на теоретическую часть
\newenvironment{lab:theory}{%
	\noindent\textbf{Теоретическая часть:~}
	\begin{small}%
	}{
	\end{small}\par
	\medskip%
}

% короткая запись для окружения lab:theory
\newcommand{\theory}[1]{%
	\begin{lab:theory}
	#1\par
	\end{lab:theory}%
}

% Добавить новую секцию без нумерации
\newcommand{\labsection}[1]{\subsection*{#1}}

\newcommand{\labsubsection}[1]{\subsubsection*{#1}}

% Секции в теорвведениях
\newcommand{\introsection}[1]{\section{#1}}
\newcommand{\introsubsection}[1]{\subsection*{#1}}

% Задание
\newenvironment{lab:task}{\subsection*{ЗАДАНИЕ}}{}

\newcommand{\tasksection}[1]{\subsubsection*{#1}}

% Контрольные вопросы
\newenvironment{lab:questions}{%
	\subsection*{Контрольные вопросы}
	\begin{enumerate}\small%
	}{
	\end{enumerate}%
}

% Литература
\newenvironment{lab:literature}{%
	\subsection*{Литература}
	\begin{enumerate}\small
	}{
	\end{enumerate}%
}

% Experiment setup block
\def\experiment{\subsection*{Экспериментальная установка}}


% Warning block environment
\newenvironment{lab:warning}{%
	\begin{tabular}{|p{0.9\textwidth}|}
	\hline\\
	\hfil\textbf{Внимание!}\par
	\begin{center}
	}{%
	\end{center}\\ \hline
	\end{tabular}%
}


% Warning block
\newcommand{\warning}[1]{%
	\begin{lab:warning}
	#1\par
	\end{lab:warning}%
}

% Термин
\newcommand{\term}[1]{\textsf{#1}}

% Important text
\newcommand{\important}[1]{\textit{#1}}


% Команда для замечаний
\newenvironment{lab:note}{%
	\par\medskip\small%
}{
	\par\medskip
}

% Команда для нумерованых примеров

\newcounter{example}[section]
\renewcommand{\theexample}{\arabic{example}}

\newenvironment{lab:example}{%
	\refstepcounter{example}%
	\par\medskip\noindent\footnotesize%
	\textbf{Пример \theexample.~}%
}{
	\par\medskip
}

%%% Нумерация
% Вставить номер уравнения внутри главы или работы
\newcommand{\eqmark}[1]{\label{eq:\arabic{chapter}.\arabic{lab}.#1}}
% Ссылка на уравнение
\renewcommand{\eqref}[1]{(\ref{eq:\arabic{chapter}.\arabic{lab}.#1})}

% Ссылка на уравнение в преамбуле главы.
% По-умолчанию используется текущая глава, но можно задать вручную
\newcommand{\chaptereqref}[2][\arabic{chapter}]{(\ref{eq:#1.0.#2})}

% Вставить номер рисунка внутри главы или работы
\newcommand{\figmark}[1]{\label{fig:\arabic{chapter}.\arabic{lab}.#1}}
% Ссылка на рисунок
\newcommand{\figref}[1]{\ref{fig:\arabic{chapter}.\arabic{lab}.#1}}

% Ссылка на рисунок в преамбуле главы. По умолчанию используется текущая глава, но можно задать вручную
\newcommand{\chapterfigref}[2][\arabic{chapter}]{\ref{fig:#1.0.#2}}

% Вставить номер рисунка внутри главы или работы
\newcommand{\tabmark}[1]{\label{tab:\arabic{chapter}.\arabic{lab}.#1}}
% Ссылка на рисунок
\newcommand{\tabref}[1]{\ref{tab:\arabic{chapter}.\arabic{lab}.#1}}


%%% Форматирование

\frenchspacing
\righthyphenmin=2

% косые больше/меньше
\renewcommand*{\le}{\leqslant}
\renewcommand*{\ge}{\geqslant}

% latex не умеет по-русски переносить равенства и неравенства
\binoppenalty=10000
\relpenalty=10000

% перенос вручную
%\newcommand*{\hm}[1]{#1\nobreak\discretionary{}{\hbox{$\mathsurround=0pt #1$}}{}}

% нумерация внутри уравнений русскими буквами
%\newcommand*{\thesubequation}{\theparentequation \asbuk{equation}}
